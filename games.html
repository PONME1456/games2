<!DOCTYPE html>

<html lang="th">

<head>

  <meta charset="UTF-8" />

  <title>Hand Space Shooter</title>

  <style>

    * { box-sizing: border-box; }

    body {

      margin: 0;

      background: #050608;

      color: #fff;

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      overflow: hidden;

    }

    #info {

      position: fixed;

      top: 10px;

      left: 10px;

      background: rgba(0, 0, 0, 0.6);

      padding: 10px 14px;

      border-radius: 10px;

      font-size: 14px;

      z-index: 20;

    }

    #info b { color: #00ffc8; }

    #scoreBox {

      position: fixed;

      top: 10px;

      right: 10px;

      background: rgba(0,0,0,0.6);

      padding: 8px 12px;

      border-radius: 10px;

      font-size: 14px;

      z-index: 20;

    }

    #gameCanvas {

      position: fixed;

      inset: 0;

    }

    /* ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô source ‡πÉ‡∏´‡πâ handCanvas */

    #video {

      display: none;

    }

    /* ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡πÄ‡∏™‡πâ‡∏ô‡∏°‡∏∑‡∏≠ */

    #handCanvas {

      position: fixed;

      right: 10px;

      bottom: 10px;

      width: 220px;

      border-radius: 10px;

      border: 2px solid #444;

      transform: scaleX(-1); /* ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏∞‡∏à‡∏Å */

      z-index: 15;

      background: #000;

    }

  </style>

  <!-- MediaPipe (fix ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£) -->

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js" crossorigin="anonymous"></script>

</head>

<body>

  <div id="info">

    üéÆ <b>Hand Space Shooter</b><br/>

    ‚úã ‡∏¢‡∏Å‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô (‡∏î‡∏π‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏∑‡∏≠‡πÇ‡∏ú‡∏•‡πà‡πÑ‡∏´‡∏°)<br/>

    ‚û° ‡∏Ç‡∏¢‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ = ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏¢‡∏≤‡∏ô<br/>

    ü´∞ ‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á‡πÅ‡∏ï‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏ä‡∏µ‡πâ = ‡∏¢‡∏¥‡∏á‡∏õ‡∏∑‡∏ô<br/>

    üí• ‡∏¢‡∏¥‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏ô‡∏•‡∏á‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô!

  </div>

  <div id="scoreBox">

    Score: <span id="score">0</span>

  </div>

  <video id="video" playsinline></video>

  <canvas id="handCanvas"></canvas>

  <canvas id="gameCanvas"></canvas>

  <script>

    // ===== DOM & canvas =====

    const video = document.getElementById("video");

    const handCanvas = document.getElementById("handCanvas");

    const handCtx = handCanvas.getContext("2d");

    const gameCanvas = document.getElementById("gameCanvas");

    const gameCtx = gameCanvas.getContext("2d");

    const scoreSpan = document.getElementById("score");

    function resizeCanvas() {

      gameCanvas.width = window.innerWidth;

      gameCanvas.height = window.innerHeight;

      handCanvas.width = 320;   // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á

      handCanvas.height = 240;

    }

    resizeCanvas();

    window.addEventListener("resize", resizeCanvas);

    // ===== ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠ =====

    let handXNorm = null;  // 0..1

    let pinchNow = false;  // ‡∏´‡∏ô‡∏µ‡∏ö‡πÇ‡∏õ‡πâ‡∏á‡πÅ‡∏ï‡∏∞‡∏ô‡∏¥‡πâ‡∏ß‡∏ä‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°

    // ===== ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡∏° =====

    let lastTime = 0;

    let score = 0;

    let enemies = [];

    let bullets = [];

    let stars = [];

    const player = {

      x: gameCanvas.width / 2,

      y: gameCanvas.height - 80,

      width: 40,

      height: 60,

      color: "#00ffc8",

    };

    let lastPinchInGame = false;

    let enemySpawnTimer = 0;

    // ‡∏î‡∏≤‡∏ß‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á

    function initStars() {

      stars = [];

      for (let i = 0; i < 80; i++) {

        stars.push({

          x: Math.random() * gameCanvas.width,

          y: Math.random() * gameCanvas.height,

          r: Math.random() * 1.5 + 0.5,

          speed: Math.random() * 30 + 10,

        });

      }

    }

    initStars();

    // ===== MediaPipe Hands =====

    const hands = new Hands({

      locateFile: file =>

        `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`,

    });

    hands.setOptions({

      maxNumHands: 1,

      modelComplexity: 1,

      minDetectionConfidence: 0.6,

      minTrackingConfidence: 0.6,

    });

    hands.onResults(onHandResults);

    let camera = null;

    async function initCamera() {

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {

        alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á (getUserMedia)");

        return;

      }

      camera = new Camera(video, {

        onFrame: async () => {

          try {

            await hands.send({ image: video });

          } catch (e) {

            console.error("‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÄ‡∏Ç‡πâ‡∏≤ hands ‡∏û‡∏±‡∏á:", e);

          }

        },

        width: 640,

        height: 480,

      });

      camera.start()

        .then(() => console.log("‚úÖ camera started"))

        .catch(err => {

          console.error("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);

          alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.name);

        });

    }

    // callback ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà MediaPipe ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à

    function onHandResults(results) {

      handCtx.save();

      handCtx.clearRect(0, 0, handCanvas.width, handCanvas.height);

      // ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏•‡∏á preview

      handCtx.drawImage(results.image, 0, 0, handCanvas.width, handCanvas.height);

      const lmList = results.multiHandLandmarks || [];

      if (

        lmList.length > 0 &&

        window.drawConnectors &&

        window.drawLandmarks &&

        window.HAND_CONNECTIONS

      ) {

        const landmarks = lmList[0];

        // ‡∏ß‡∏≤‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î ‡πÜ

        drawConnectors(handCtx, landmarks, HAND_CONNECTIONS, { lineWidth: 2 });

        drawLandmarks(handCtx, landmarks, { lineWidth: 1 });

        const indexTip = landmarks[8]; // ‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏ä‡∏µ‡πâ

        const thumbTip = landmarks[4]; // ‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á

        // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ô‡∏¥‡πâ‡∏ß‡∏ä‡∏µ‡πâ 0..1 (‡πÅ‡∏Å‡∏ô x) ‚Üí ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏∞‡∏à‡∏Å

        handXNorm = 1 - indexTip.x;

        // ‡∏£‡∏∞‡∏¢‡∏∞‡πÇ‡∏õ‡πâ‡∏á-‡∏ä‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ pinch

        const dx = thumbTip.x - indexTip.x;

        const dy = thumbTip.y - indexTip.y;

        const dist = Math.sqrt(dx * dx + dy * dy);

        pinchNow = dist < 0.05; // ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡∏î‡∏∑‡πâ‡∏≠

      } else {

        // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏°‡∏∑‡∏≠‡πÉ‡∏ô‡πÄ‡∏ü‡∏£‡∏°

        handXNorm = null;

        pinchNow = false;

      }

      handCtx.restore();

    }

    initCamera();

    // ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡∏° =====

    function spawnEnemy() {

      const w = 40;

      const h = 40;

      enemies.push({

        x: Math.random() * (gameCanvas.width - w) + w / 2,

        y: -50,

        width: w,

        height: h,

        speed: 80 + Math.random() * 80,

        color: "#ff4b81",

      });

    }

    function spawnBullet() {

      bullets.push({

        x: player.x,

        y: player.y - player.height / 2,

        radius: 5,

        speed: 300,

        color: "#ffd447",

      });

    }

    function rectsOverlap(a, b) {

      return !(

        a.x + a.width / 2 < b.x - b.width / 2 ||

        a.x - a.width / 2 > b.x + b.width / 2 ||

        a.y + a.height / 2 < b.y - b.height / 2 ||

        a.y - a.height / 2 > b.y + b.height / 2

      );

    }

    function bulletHitsEnemy(bullet, enemy) {

      const bRect = {

        x: bullet.x,

        y: bullet.y,

        width: bullet.radius * 2,

        height: bullet.radius * 2,

      };

      return rectsOverlap(

        { x: enemy.x, y: enemy.y, width: enemy.width, height: enemy.height },

        bRect

      );

    }

    function update(dt) {

      // ‡∏î‡∏≤‡∏ß‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á

      for (const s of stars) {

        s.y += s.speed * dt;

        if (s.y > gameCanvas.height) {

          s.y = -5;

          s.x = Math.random() * gameCanvas.width;

        }

      }

      // ‡∏¢‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏°‡∏∑‡∏≠

      if (handXNorm !== null) {

        player.x = handXNorm * gameCanvas.width;

      }

      player.x = Math.max(

        player.width / 2,

        Math.min(gameCanvas.width - player.width / 2, player.x)

      );

      // pinch ‡∏à‡∏≤‡∏Å false -> true = ‡∏¢‡∏¥‡∏á 1 ‡∏ô‡∏±‡∏î

      if (pinchNow && !lastPinchInGame) {

        spawnBullet();

      }

      lastPinchInGame = pinchNow;

      // ‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô

      bullets.forEach(b => {

        b.y -= b.speed * dt;

      });

      bullets = bullets.filter(b => b.y + b.radius > 0);

      // spawn ‡∏®‡∏±‡∏ï‡∏£‡∏π

      enemySpawnTimer += dt;

      if (enemySpawnTimer > 1.0) {

        enemySpawnTimer = 0;

        spawnEnemy();

      }

      // ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏•‡∏á

      enemies.forEach(e => {

        e.y += e.speed * dt;

      });

      enemies = enemies.filter(e => e.y - e.height / 2 < gameCanvas.height + 50);

      // ‡∏ä‡∏ô‡∏Å‡∏±‡∏ô

      for (let i = enemies.length - 1; i >= 0; i--) {

        let dead = false;

        for (let j = bullets.length - 1; j >= 0; j--) {

          if (bulletHitsEnemy(bullets[j], enemies[i])) {

            bullets.splice(j, 1);

            dead = true;

            score += 10;

            scoreSpan.textContent = score;

            break;

          }

        }

        if (dead) enemies.splice(i, 1);

      }

    }

    function draw() {

      // background

      const grad = gameCtx.createLinearGradient(0, 0, 0, gameCanvas.height);

      grad.addColorStop(0, "#050608");

      grad.addColorStop(1, "#080022");

      gameCtx.fillStyle = grad;

      gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

      // stars

      gameCtx.fillStyle = "#ffffff";

      for (const s of stars) {

        gameCtx.beginPath();

        gameCtx.arc(s.x, s.y, s.r, 0, Math.PI * 2);

        gameCtx.fill();

      }

      // player ship

      gameCtx.save();

      gameCtx.translate(player.x, player.y);

      gameCtx.fillStyle = player.color;

      gameCtx.beginPath();

      gameCtx.moveTo(0, -player.height / 2);

      gameCtx.lineTo(-player.width / 2, player.height / 2);

      gameCtx.lineTo(player.width / 2, player.height / 2);

      gameCtx.closePath();

      gameCtx.fill();

      // flame

      gameCtx.fillStyle = "#ff7b54";

      gameCtx.beginPath();

      gameCtx.moveTo(-player.width / 4, player.height / 2);

      gameCtx.lineTo(0, player.height / 2 + 15);

      gameCtx.lineTo(player.width / 4, player.height / 2);

      gameCtx.fill();

      gameCtx.restore();

      // bullets

      for (const b of bullets) {

        gameCtx.fillStyle = b.color;

        gameCtx.beginPath();

        gameCtx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);

        gameCtx.fill();

      }

      // enemies

      for (const e of enemies) {

        gameCtx.save();

        gameCtx.translate(e.x, e.y);

        gameCtx.fillStyle = e.color;

        gameCtx.fillRect(-e.width / 2, -e.height / 2, e.width, e.height);

        // ‡∏ï‡∏≤‡∏®‡∏±‡∏ï‡∏£‡∏π

        gameCtx.fillStyle = "#fff";

        gameCtx.fillRect(-e.width / 4, -e.height / 6, 6, 6);

        gameCtx.fillRect(e.width / 4 - 6, -e.height / 6, 6, 6);

        gameCtx.restore();

      }

    }

    function gameLoop(ts) {

      if (!lastTime) lastTime = ts;

      const dt = (ts - lastTime) / 1000;

      lastTime = ts;

      update(dt);

      draw();

      requestAnimationFrame(gameLoop);

    }

    requestAnimationFrame(gameLoop);

  </script>

</body>

</html>
